# ファイル共有用のウェブアプリ

## 要件リスト

* マルチテナント型として、共有のすべての操作は各テナント内で完結する形にする
  * 各テナントごとに管理画面が提供される
* 各テナント内に特定条件付きのアップロードフォームの設定が可能になるようにする
  * アップロードしたファイルのダウンロード用リンクを提供するかどうかは選択可能にする
* ファイルに付随する情報の設定
  * ファイルについての説明（自由文章）
  * ラベル機能
* 個別ファイルはハッシュキーで特定されるようにして、ダウンロードリンクが自動的にできるようにする
  * (TBD) ダウンロード用画面をいったん挟むか？ (ファイルについての説明とかを表示する画面は必要に思える)
* 複数ファイル一括アップロード機能・グループ化情報の保持
  * アップロード画面は複数ファイルをアップロードできるようにする
  * グループのダウンロード画面は、グループのファイル全部をzipで落とすか、個別ファイルを落とすかの両方を表示する
* 一括ダウンロード機能
  * テナント内全部
  * テナント内の特定のラベルが付いたもの全部
    * 複数ラベルが存在するのを条件とするのもできるようにするか？
* アクセスキーでの制限
  * 管理画面は必須
  * アップロード・ダウンロードの画面はhash URLにしてアクセスキーをなくす？
    * hash URLの上にアクセスキーを付けてどの程度の効果が見込まれるか？ (リンク漏れ対策には有効ではある)
* 特定のドメインをターゲットにproxy的な扱いをする機能を入れる
  * proxyで取ってくるファイルの追加は管理画面からのみ設定できるようにする
  * fes-storageとかの大容量ビデオ置き場系とかから (BASICはauth設定で内部扱いにしておく必要あり)
  * アーカイブ化として、テナント全体をproxyのターゲットに置き換える機能も提供する
    * 裏側のストレージはテナントごとのハッシュディレクトリの必要がある
    * proxyのターゲットからの提供にした際に一括ダウンロードをどうやって実現するか (proxy先にPOSTでのzip化するだけのスクリプトを置く？)
* 単一テナント全体のアーカイブ機能
  * 一括で転送先URLのヘッダを指定できるようにする
  * ダウンロードAPIはproxyとし、MIME typeはデータベースからとってつける (転送先は単なるストレージ扱い)
  * 対象ファイルリストを出力できる機能を付けるが、ハッシュディレクトリでのzip化や一括消去は付けない (シェルでやれ、で)

### 要件整理

* グループについて
  * 内部的にはラベルの特殊形態とする
  * アップロード画面では2つのアップロード方法を選択できるようにする: 複数ファイルアップロード、zipファイルアップロード
    * 複数ファイルを同時にアップロード可能とする、この場合既定でグループ化を行う。(グループ解除は不可)
    * zipファイルアップロードではサーバ側で展開し、グループ化を行う
  * グループはラベルなどの一括ダウンロードの場合にはディレクトリに読み替える
  * グループ全体、と、個別ファイルそれぞれの、ダウンロード用ハッシュリンクが生成される
  * グループにラベルが付いた場合、その中の個別ファイルから該当のラベルを外すことは不可、ラベルの追加は許可する
* アップロード画面の提供について
  * 既定で管理キーで認証するハッシュURLを一つ提供する。ここからのアップロードではラベルの付与などすべての機能が利用可能にしておく。(内部関係者の利用向け)
  * ラベルごとに一つのハッシュURLが自動でできるようにする。
* ダウンロード画面の提供について
  * 個別ファイルダウンロード画面ではそのままダウンロードする (UIなし)
  * まとめてののダウンロード画面
    * グループであれば、グループ全体をzipでダウンロードするリンクと、ファイル個別にダウンロードするリンクを提供する
    * ラベル全体であれば、ラベルに紐づいたグループ・個別ファイルの全部のリストを出す、ダウンロードリンクはラベル全体・各グループ・個別ファイルの3階層すべて

## システム・URL構成

* 基本要件
  * 画面についてはserver pathでの扱いとし、htmlのスクリプトでpathを見てアクセス情報とする

* `/` : トップページはシステム概要とリンク（利用説明・管理画面）を掲載程度
* `/tn/<tenant>/` : テナントについての説明とリンク（管理画面）
  * `/tn/<tenant>/admin/` : 管理画面 (管理用キー必須とする)
  * `/tn/<tenant>/up/<hash>/` : アップロード画面
  * `/tn/<tenant>/dl/<hash>/` : 単一ファイルの表示画面 (グループと合わせる？)
  * `/tn/<tenant>/dg/<hash>/` : グループの表示画面
* `/docs/` : システムマニュアル
* `/admin/` : 全体管理用画面 (BASICも付けてもいいかも？＆ほぼテナントリストだけ)
  * `/admin/api/` : 全体管理系専用API用ディレクトリ
  * `/admin/api/tenants.cgi` : テナント一覧、新規テナント追加機能
* `/api/` : API用ディレクトリ
  * `/api/dl.cgi?hash=<hash>`: ハッシュに対応する個別ファイルもしくはzipファイルのダウンロード
  * `/api/tn.cgi?tn=<tenant>`: テナントに関する情報


## API機能要件

* 前提
  * テナントのリストはadmin系でのみ供給する
